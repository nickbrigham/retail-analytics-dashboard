<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Black Tie Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* COSMOS Design System v2 - Enhanced 3D & Glow */
:root {
  --bg: #050713;
  --surface-dark: rgb(17 24 39);
  --surface-medium: rgb(31 41 55);
  --surface-elevated: rgba(22, 32, 50, 0.95);
  --blue-500: #3B82F6;
  --blue-600: #2563EB;
  --blue-glow: rgba(59, 130, 246, 0.5);
  --green-500: #10B981;
  --green-glow: rgba(16, 185, 129, 0.5);
  --orange-500: #F97316;
  --red-500: #EF4444;
  --purple-500: #8B5CF6;
  --purple-glow: rgba(139, 92, 246, 0.5);
  --yellow-500: #F59E0B;
  --text-primary: white;
  --text-secondary: rgb(209 213 219);
  --text-tertiary: rgb(156 163 175);
  --text-muted: rgb(107 114 128);
  --border-subtle: rgba(59, 130, 246, 0.15);
  --border-hover: rgba(59, 130, 246, 0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
}

body::before, body::after {
  content: '';
  position: fixed;
  border-radius: 50%;
  filter: blur(120px);
  z-index: -1;
  animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

body::before {
  top: -10%;
  right: -5%;
  width: 40%;
  height: 40%;
  background: rgba(59, 130, 246, 0.12);
}

body::after {
  bottom: -10%;
  left: -5%;
  width: 35%;
  height: 35%;
  background: rgba(139, 92, 246, 0.1);
}

@keyframes pulse-slow {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.05); }
}

@keyframes fade-in-up {
  0% { opacity: 0; transform: translateY(10px); }
  100% { opacity: 1; transform: translateY(0); }
}

/* Loading State */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  gap: 20px;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border-subtle);
  border-top-color: var(--blue-500);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--text-tertiary);
  font-size: 14px;
}

.error-state {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  gap: 16px;
  text-align: center;
  padding: 24px;
}

.error-state.show {
  display: flex;
}

.error-icon {
  font-size: 48px;
}

.error-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--red-500);
}

.error-message {
  color: var(--text-tertiary);
  max-width: 400px;
}

.dashboard { display: none; }
.dashboard.show { display: block; }

/* Header */
.header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(17, 24, 39, 0.8);
  backdrop-filter: blur(16px);
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
}

.logo {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 20px var(--blue-glow), 0 4px 15px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
}

.logo-icon:hover {
  transform: scale(1.05) rotate(3deg);
  box-shadow: 0 0 30px var(--blue-glow), 0 6px 20px rgba(0, 0, 0, 0.4);
}

.logo-icon svg {
  width: 26px;
  height: 26px;
  color: white;
  filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
}

.logo-text h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.025em;
  color: white;
  text-shadow: 0 0 20px var(--blue-glow);
}

.logo-text span {
  font-size: 12px;
  font-weight: 400;
  color: var(--text-tertiary);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.admin-link {
  font-size: 12px;
  color: var(--text-muted);
  text-decoration: none;
  padding: 8px 14px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.admin-link:hover {
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.05);
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 18px;
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 9999px;
  font-size: 13px;
  font-weight: 500;
  color: var(--blue-500);
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
  transition: all 0.3s ease;
}

.status-badge:hover {
  box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
  transform: scale(1.02);
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: var(--blue-500);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--blue-500);
  animation: pulse-slow 2s ease-in-out infinite;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 24px;
}

.grid2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 28px; }
.grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 28px; }
.grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 28px; }
.grid5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 28px; }

.kpi-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  animation: fade-in-up 0.5s ease-out forwards;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
}

.kpi-card::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 60%);
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
}

.kpi-card:hover {
  transform: translateY(-10px) scale(1.03);
  border-color: var(--blue-500);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 25px 50px rgba(59, 130, 246, 0.2), 0 0 40px rgba(59, 130, 246, 0.15), 0 1px 0 rgba(255, 255, 255, 0.1) inset;
}

.kpi-card:hover::after { opacity: 1; }

.kpi-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.kpi-label {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-tertiary);
}

.kpi-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
  transition: all 0.3s ease;
}

.kpi-card:hover .kpi-icon {
  transform: scale(1.15) rotate(8deg);
  box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
}

.kpi-icon svg {
  width: 20px;
  height: 20px;
  color: var(--blue-500);
  filter: drop-shadow(0 0 4px var(--blue-glow));
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -0.03em;
  color: white;
  text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
  margin-bottom: 12px;
  position: relative;
  z-index: 1;
}

.kpi-card:hover .kpi-value { text-shadow: 0 0 40px rgba(59, 130, 246, 0.5); }

.kpi-compare {
  display: flex;
  gap: 20px;
  font-size: 12px;
  position: relative;
  z-index: 1;
}

.kpi-compare .label {
  color: var(--text-muted);
  margin-right: 6px;
}

.up { color: var(--green-500); text-shadow: 0 0 8px var(--green-glow); }
.down { color: var(--red-500); text-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }

.actions {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 28px;
  margin-bottom: 28px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
}

.actions h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--blue-500);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  text-shadow: 0 0 15px var(--blue-glow);
}

.action {
  display: flex;
  gap: 16px;
  padding: 18px;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
  border-radius: 14px;
  margin-bottom: 14px;
  border: 1px solid transparent;
  border-left: 4px solid var(--blue-500);
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.action:hover {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  border-color: rgba(59, 130, 246, 0.2);
  transform: translateX(8px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
}

.action.urgent { border-left-color: var(--red-500); }
.action.urgent:hover { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); box-shadow: 0 4px 16px rgba(239, 68, 68, 0.15); }
.action.warning { border-left-color: var(--orange-500); }
.action.warning:hover { background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.05)); box-shadow: 0 4px 16px rgba(249, 115, 22, 0.15); }

.action-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
}

.action-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); color: var(--blue-500); }
.action.urgent .action-icon { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)); color: var(--red-500); box-shadow: 0 0 12px rgba(239, 68, 68, 0.3); }
.action.warning .action-icon { background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(249, 115, 22, 0.1)); color: var(--orange-500); box-shadow: 0 0 12px rgba(249, 115, 22, 0.3); }

.action-title { font-size: 14px; font-weight: 600; color: white; margin-bottom: 4px; }
.action-text { font-size: 13px; color: var(--text-tertiary); margin-bottom: 8px; }
.action-cta { font-size: 12px; color: var(--blue-500); font-weight: 600; text-shadow: 0 0 8px var(--blue-glow); }

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 28px;
  flex-wrap: wrap;
  padding: 6px;
  background: linear-gradient(145deg, rgba(17, 24, 39, 0.7), rgba(10, 15, 26, 0.8));
  border-radius: 16px;
  border: 1px solid var(--border-subtle);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.03) inset;
}

.tab {
  padding: 14px 24px;
  background: transparent;
  border: none;
  border-radius: 10px;
  color: var(--text-tertiary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
}

.tab:hover {
  color: white;
  background: rgba(59, 130, 246, 0.1);
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}

.tab.active {
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  color: white;
  box-shadow: 0 0 20px var(--blue-glow), 0 4px 12px rgba(0, 0, 0, 0.3);
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.tab-content { display: none; }
.tab-content.active { display: block; animation: fade-in-up 0.4s ease-out; }

.store-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 28px; }

.store-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 28px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}

.store-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  border-radius: 20px 20px 0 0;
}

.store-card:first-child::before { background: linear-gradient(90deg, var(--blue-600), var(--blue-500)); box-shadow: 0 0 20px var(--blue-glow); }
.store-card:last-child::before { background: linear-gradient(90deg, var(--purple-500), #A855F7); box-shadow: 0 0 20px var(--purple-glow); }

.store-card:hover {
  transform: translateY(-10px) scale(1.02);
  border-color: var(--border-hover);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 25px 50px rgba(59, 130, 246, 0.15), 0 0 40px rgba(59, 130, 246, 0.1);
}

.store-card:last-child:hover {
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 25px 50px rgba(139, 92, 246, 0.15), 0 0 40px rgba(139, 92, 246, 0.1);
}

.store-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.store-name { font-size: 20px; font-weight: 700; letter-spacing: -0.025em; }
.store-card:first-child .store-name { color: var(--blue-500); text-shadow: 0 0 15px var(--blue-glow); }
.store-card:last-child .store-name { color: var(--purple-500); text-shadow: 0 0 15px var(--purple-glow); }
.store-txns { font-size: 13px; color: var(--text-muted); }

.store-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

.store-metric {
  padding: 18px;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
}

.store-card:hover .store-metric {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(0, 0, 0, 0.2));
  border-color: rgba(59, 130, 246, 0.1);
}

.store-metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 10px; }
.store-metric-value { font-size: 28px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 12px; }
.store-card:first-child .store-metric-value { color: var(--blue-500); text-shadow: 0 0 20px var(--blue-glow); }
.store-card:last-child .store-metric-value { color: var(--purple-500); text-shadow: 0 0 20px var(--purple-glow); }

.store-cmp { display: flex; gap: 20px; }
.store-cmp-item { display: flex; flex-direction: column; gap: 3px; }
.store-cmp-lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
.store-cmp-val { font-size: 13px; font-weight: 600; }

.chart-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 28px;
  margin-bottom: 28px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
  transition: all 0.4s ease;
}

.chart-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 20px 40px rgba(59, 130, 246, 0.1);
}

.chart-card h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--blue-500);
  margin-bottom: 24px;
  text-shadow: 0 0 15px var(--blue-glow);
}

.chart-box { height: 300px; }

.table-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 28px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
  transition: all 0.4s ease;
}

.table-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 20px 40px rgba(59, 130, 246, 0.1);
}

.table-card > h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--blue-500);
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  gap: 12px;
  text-shadow: 0 0 15px var(--blue-glow);
}

.table-desc { font-size: 12px; color: var(--text-muted); font-weight: 400; text-shadow: none; }
.table-wrap { overflow-x: auto; max-height: 500px; overflow-y: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 16px 24px; text-align: left; border-bottom: 1px solid rgba(59, 130, 246, 0.1); font-size: 13px; }
th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); background: rgba(0, 0, 0, 0.4); position: sticky; top: 0; }
td { color: var(--text-secondary); }
tr { transition: all 0.2s ease; }
tr:hover td { background: rgba(59, 130, 246, 0.08); color: white; }
.right { text-align: right; }
.green { color: var(--green-500); text-shadow: 0 0 8px var(--green-glow); }
.red { color: var(--red-500); text-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
.yellow { color: var(--yellow-500); text-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }
.cyan { color: #22D3EE; text-shadow: 0 0 8px rgba(34, 211, 238, 0.5); }
.purple { color: var(--purple-500); text-shadow: 0 0 8px var(--purple-glow); }
.blue { color: var(--blue-500); text-shadow: 0 0 8px var(--blue-glow); }

.badge { display: inline-flex; padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.badge-high, .badge-critical, .badge-urgent { background: rgba(239, 68, 68, 0.15); color: var(--red-500); box-shadow: 0 0 10px rgba(239, 68, 68, 0.2); }
.badge-medium, .badge-review { background: rgba(249, 115, 22, 0.15); color: var(--orange-500); box-shadow: 0 0 10px rgba(249, 115, 22, 0.2); }
.badge-low, .badge-ok, .badge-vip { background: rgba(16, 185, 129, 0.15); color: var(--green-500); box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }
.badge-regular { background: rgba(59, 130, 246, 0.15); color: var(--blue-500); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }

.ctx-flags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
.ctx-flag { font-size: 10px; padding: 4px 10px; background: rgba(139, 92, 246, 0.15); border-radius: 6px; color: var(--purple-500); box-shadow: 0 0 8px rgba(139, 92, 246, 0.2); }

.seg-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 28px;
  text-align: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.seg-card:hover {
  transform: translateY(-8px) scale(1.03);
  border-color: var(--border-hover);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 40px rgba(59, 130, 246, 0.1);
}

.seg-name { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 14px; }
.seg-count { font-size: 40px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 10px; }
.seg-rev { font-size: 13px; color: var(--text-tertiary); }

.ret-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 28px; }

.ret-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 24px;
  text-align: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.ret-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 40px rgba(59, 130, 246, 0.1); }
.ret-val { font-size: 36px; font-weight: 700; letter-spacing: -0.03em; color: var(--blue-500); text-shadow: 0 0 25px var(--blue-glow); }
.ret-lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-top: 10px; }

.churn-stats { display: flex; gap: 20px; margin-bottom: 28px; flex-wrap: wrap; }

.churn-stat {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 24px 28px;
  flex: 1;
  min-width: 150px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.churn-stat:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 30px rgba(59, 130, 246, 0.1); }
.churn-val { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; }
.churn-lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 6px; }

.cohort-cell { text-align: center; min-width: 110px; padding: 18px 10px; }
.cohort-val { font-size: 15px; font-weight: 700; color: var(--blue-500); text-shadow: 0 0 10px var(--blue-glow); }
.cohort-ret { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.cohort-bar { height: 4px; background: rgba(59, 130, 246, 0.2); border-radius: 2px; margin-top: 10px; overflow: hidden; }
.cohort-fill { height: 100%; background: linear-gradient(90deg, var(--blue-600), var(--blue-500)); border-radius: 2px; box-shadow: 0 0 10px var(--blue-glow); }

.staff-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 28px; }

.staff-card {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 24px;
  border-left: 4px solid var(--green-500);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), -4px 0 15px rgba(16, 185, 129, 0.15);
  transition: all 0.4s ease;
}

.staff-card:hover { transform: translateX(8px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), -4px 0 25px rgba(16, 185, 129, 0.25); }
.staff-card.slow { border-left-color: var(--orange-500); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), -4px 0 15px rgba(249, 115, 22, 0.15); }
.staff-card.slow:hover { box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), -4px 0 25px rgba(249, 115, 22, 0.25); }

.staff-day { font-size: 20px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.025em; }
.staff-type { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--green-500); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; text-shadow: 0 0 10px var(--green-glow); }
.staff-card.slow .staff-type { color: var(--orange-500); text-shadow: 0 0 10px rgba(249, 115, 22, 0.5); }
.staff-rec { font-size: 13px; color: var(--text-tertiary); line-height: 1.7; }

.seasonal-alerts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 28px; }

.s-alert {
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.95), rgba(15, 23, 42, 0.9));
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-subtle);
  border-radius: 20px;
  padding: 24px;
  display: flex;
  gap: 18px;
  align-items: flex-start;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2);
  transition: all 0.4s ease;
}

.s-alert:hover { transform: translateY(-6px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 30px rgba(59, 130, 246, 0.1); }
.s-alert.warning { border-left: 4px solid var(--orange-500); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), -4px 0 15px rgba(249, 115, 22, 0.1); }
.s-alert.positive { border-left: 4px solid var(--green-500); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2), -4px 0 15px rgba(16, 185, 129, 0.1); }
.s-alert-icon { font-size: 28px; }
.s-alert h4 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
.s-alert.warning h4 { color: var(--orange-500); text-shadow: 0 0 12px rgba(249, 115, 22, 0.5); }
.s-alert.positive h4 { color: var(--green-500); text-shadow: 0 0 12px var(--green-glow); }
.s-alert p { font-size: 13px; color: var(--text-tertiary); margin-bottom: 10px; line-height: 1.6; }
.s-alert-action { font-size: 12px; color: var(--blue-500); font-weight: 600; text-shadow: 0 0 8px var(--blue-glow); }

.week-forecast { display: flex; flex-direction: column; gap: 16px; }

.week-row {
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
  border-radius: 14px;
  padding: 20px 24px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
}

.week-row:hover {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(0, 0, 0, 0.2));
  border-color: rgba(16, 185, 129, 0.2);
  transform: translateX(4px);
}

.week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.week-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
.week-total { font-size: 22px; font-weight: 700; color: var(--green-500); letter-spacing: -0.03em; text-shadow: 0 0 15px var(--green-glow); }

.week-days { display: flex; gap: 10px; }

.day-pill {
  flex: 1;
  text-align: center;
  padding: 14px 8px;
  background: rgba(16, 185, 129, 0.08);
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-radius: 10px;
  transition: all 0.3s ease;
}

.day-pill:hover { background: rgba(16, 185, 129, 0.15); transform: translateY(-4px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15); }
.day-pill .day-name { font-size: 10px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.08em; }
.day-pill .day-val { font-size: 13px; color: var(--green-500); font-weight: 700; text-shadow: 0 0 8px var(--green-glow); }

.months-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-bottom: 28px; }

.month-card {
  text-align: center;
  padding: 22px 12px;
  background: linear-gradient(145deg, rgba(22, 32, 50, 0.9), rgba(15, 23, 42, 0.85));
  border-radius: 14px;
  border: 1px solid var(--border-subtle);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.month-card:hover { transform: translateY(-6px) scale(1.05); border-color: var(--border-hover); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.1); }

.month-card.peak {
  border-color: var(--green-500);
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(15, 23, 42, 0.9));
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 20px rgba(16, 185, 129, 0.15);
}

.month-card.peak:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3), 0 0 35px rgba(16, 185, 129, 0.25); }

.month-card.low {
  border-color: var(--red-500);
  background: linear-gradient(145deg, rgba(239, 68, 68, 0.08), rgba(15, 23, 42, 0.9));
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 20px rgba(239, 68, 68, 0.1);
}

.month-card.low:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3), 0 0 35px rgba(239, 68, 68, 0.2); }

.month-name { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; }
.month-index { font-size: 26px; font-weight: 700; letter-spacing: -0.03em; color: white; }
.month-card.peak .month-index { color: var(--green-500); text-shadow: 0 0 15px var(--green-glow); }
.month-card.low .month-index { color: var(--red-500); text-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
.month-pct { font-size: 12px; margin-top: 6px; color: var(--text-tertiary); }

.section-header { font-size: 16px; font-weight: 700; color: var(--blue-500); margin-bottom: 20px; text-shadow: 0 0 20px var(--blue-glow); }

@media (max-width: 1200px) {
  .grid5, .grid4, .ret-cards { grid-template-columns: repeat(2, 1fr); }
  .grid2, .store-cards, .staff-cards, .seasonal-alerts { grid-template-columns: 1fr; }
  .months-grid { grid-template-columns: repeat(6, 1fr); }
}

@media (max-width: 640px) {
  .months-grid { grid-template-columns: repeat(4, 1fr); }
  .grid5, .grid4, .grid3, .ret-cards { grid-template-columns: 1fr; }
  .container { padding: 16px; }
  .header { flex-direction: column; gap: 12px; }
  .header-right { width: 100%; justify-content: space-between; }
}
/* Admin Modal */
.admin-modal {

/* Sortable Tables */
th.sortable { cursor: pointer; user-select: none; position: relative; }
th.sortable:hover { color: var(--blue-500); }
th.sortable::after { content: '‚áÖ'; margin-left: 6px; opacity: 0.3; font-size: 12px; }
th.sortable.asc::after { content: '‚Üë'; opacity: 1; }
th.sortable.desc::after { content: '‚Üì'; opacity: 1; }

/* Admin Modal */
.admin-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
}
.admin-modal.show { display: flex; }
.admin-content {
  background: var(--surface-elevated);
  border: 1px solid var(--border-subtle);
  border-radius: 24px;
  padding: 40px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0,0,0,0.5);
}
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}
.admin-header h2 {
  font-size: 20px;
  color: var(--blue-500);
  text-shadow: 0 0 20px var(--blue-glow);
}
.admin-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 28px;
  cursor: pointer;
  padding: 0;
  line-height: 1;
}
.admin-close:hover { color: white; }
.admin-drop {
  border: 2px dashed var(--border-subtle);
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 20px;
}
.admin-drop:hover, .admin-drop.dragover {
  border-color: var(--blue-500);
  background: rgba(59,130,246,0.05);
}
.admin-drop input { display: none; }
.admin-drop-text { font-size: 16px; color: var(--text-secondary); margin-bottom: 8px; }
.admin-drop-hint { font-size: 13px; color: var(--text-muted); }
.admin-files { margin-bottom: 20px; }
.admin-file {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  margin-bottom: 8px;
  font-size: 14px;
}
.admin-file-icon { font-size: 20px; }
.admin-file-info { flex: 1; }
.admin-file-name { color: var(--text-primary); }
.admin-file-meta { font-size: 12px; color: var(--text-muted); }
.admin-file-check { color: var(--green-500); }
.admin-btn {
  width: 100%;
  padding: 16px;
  font-size: 15px;
  font-weight: 600;
  background: var(--blue-600);
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(37,99,235,0.4);
}
.admin-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(37,99,235,0.5);
}
.admin-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.admin-status {
  margin-top: 20px;
  padding: 16px;
  border-radius: 12px;
  font-size: 14px;
  display: none;
}
.admin-status.show { display: block; }
.admin-status.success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: var(--green-500); }
.admin-status.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--red-500); }
.admin-status.processing { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); color: var(--blue-500); }
</style>
</head>
<body>

<!-- Loading State -->
<div class="loading" id="loadingState">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading dashboard data...</div>
</div>

<!-- Error State -->
<div class="error-state" id="errorState">
  <div class="error-icon">‚ö†Ô∏è</div>
  <div class="error-title">Unable to Load Data</div>
  <div class="error-message">Could not load dashboard data. Please ensure data.json exists and try refreshing the page.</div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<header class="header">
<div class="logo">
<div class="logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg></div>
<div class="logo-text"><h1>Black Tie Analytics</h1><span>Store Performance Dashboard</span></div>
</div>
<div class="header-right">
<a href="admin.html" class="admin-link">‚öôÔ∏è Admin</a>
<div class="status-badge"><span class="pulse-dot"></span><span id="dataPeriod">Loading...</span></div>
</div>
</header>
<div class="container">
<div class="grid5" id="kpis"></div>
<div class="actions"><h3>‚ö° Action Items</h3><div id="actionItems"></div></div>
<div class="tabs">
<button class="tab active" data-tab="health">Store Health</button>
<button class="tab" data-tab="products">Product Performance</button>
<button class="tab" data-tab="team">Team Performance</button>
<button class="tab" data-tab="customers">Customer Health</button>
<button class="tab" data-tab="planning">Planning</button>
</div>

<div class="tab-content active" id="health">
<div class="store-cards" id="storeCards"></div>
<div class="chart-card"><h3>üìà Daily Revenue Trend</h3><div class="chart-box"><canvas id="revenueChart"></canvas></div></div>
</div>

<div class="tab-content" id="products">
<div class="grid2">
<div class="table-card"><h3>‚ö†Ô∏è Margin Alerts<span class="table-desc">Products below 40% margin</span></h3><div class="table-wrap"><table id="marginAlertsTable"><thead><tr><th class="sortable" data-col="0">Product</th><th class="sortable" data-col="1">Store</th><th class="sortable right" data-col="2">Revenue</th><th class="sortable right" data-col="3">Margin</th><th class="sortable right" data-col="4">Price ‚Üë</th><th class="sortable" data-col="5">Status</th></tr></thead><tbody id="marginAlerts"></tbody></table></div></div>
<div class="table-card"><h3>üîÑ Reorder Soon<span class="table-desc">High velocity items</span></h3><div class="table-wrap"><table id="reorderRecsTable"><thead><tr><th class="sortable" data-col="0">Product</th><th class="sortable" data-col="1">Category</th><th class="sortable right" data-col="2">Velocity</th><th class="sortable right" data-col="3">Order Qty</th><th class="sortable" data-col="4">Urgency</th></tr></thead><tbody id="reorderRecs"></tbody></table></div></div>
</div>
<div class="table-card"><h3>üèÜ Top Performers<span class="table-desc">By profit</span></h3><div class="table-wrap"><table id="topPerformersTable"><thead><tr><th class="sortable" data-col="0">Product</th><th class="sortable" data-col="1">Category</th><th class="sortable right" data-col="2">Units</th><th class="sortable right" data-col="3">Revenue</th><th class="sortable right" data-col="4">Profit</th><th class="sortable right" data-col="5">Margin</th></tr></thead><tbody id="topPerformers"></tbody></table></div></div>
<div class="chart-card"><h3>üìä Category Mix</h3><div class="chart-box"><canvas id="categoryChart"></canvas></div></div>
</div>

<div class="tab-content" id="team">
<div class="staff-cards" id="staffingRecs"></div>
<div class="table-card"><h3>üë• Budtender Scorecard<span class="table-desc">Context flags explain variations</span></h3><div class="table-wrap"><table id="budtenderTableWrap"><thead><tr><th class="sortable" data-col="0">Name</th><th class="sortable" data-col="1">Store</th><th class="sortable right" data-col="2">Revenue</th><th class="sortable right" data-col="3">Txns</th><th class="sortable right" data-col="4">Avg Ticket</th><th class="sortable right" data-col="5">vs Team</th><th class="sortable right" data-col="6">Items/Txn</th><th data-col="7">Context</th></tr></thead><tbody id="budtenderTable"></tbody></table></div></div>
</div>

<div class="tab-content" id="customers">
<div class="ret-cards" id="retentionCards"></div>
<div class="grid4" id="segments"></div>
<div class="churn-stats" id="churnStats"></div>
<div class="table-card"><h3>üö® Churn Risk<span class="table-desc">Customers at risk</span></h3><div class="table-wrap"><table id="churnTableWrap"><thead><tr><th class="sortable" data-col="0">Risk</th><th class="sortable" data-col="1">Customer</th><th class="sortable" data-col="2">Segment</th><th class="sortable right" data-col="3">Churn %</th><th class="sortable right" data-col="4">$ at Risk</th><th class="sortable right" data-col="5">Total Spend</th><th class="sortable" data-col="6">Last Visit</th></tr></thead><tbody id="churnTable"></tbody></table></div></div>
<div class="table-card"><h3>üõí Cross-Category Pairs<span class="table-desc">Different categories bought together</span></h3><div class="table-wrap"><table id="pairsTableWrap"><thead><tr><th class="sortable" data-col="0">Product A</th><th class="sortable" data-col="1">Category</th><th class="sortable" data-col="2">Product B</th><th class="sortable" data-col="3">Category</th><th class="sortable right" data-col="4">Times</th><th class="sortable right" data-col="5">Lift</th></tr></thead><tbody id="pairsTable"></tbody></table></div></div>
<div class="table-card"><h3>üìä Cohort Retention</h3><div class="table-wrap"><table><thead id="cohortHead"></thead><tbody id="cohortTable"></tbody></table></div></div>
</div>

<div class="tab-content" id="planning">
<div class="seasonal-alerts" id="seasonalAlerts"></div>
<div class="grid2">
<div class="chart-card"><h3>üìÜ Next 4 Weeks Forecast</h3><div id="weekForecast"></div></div>
<div class="chart-card"><h3>üìà 2024 vs 2025</h3><div class="chart-box"><canvas id="yoyChart"></canvas></div></div>
</div>
<h3 class="section-header">Monthly Seasonality Index</h3>
<div class="months-grid" id="monthsGrid"></div>
</div>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// ========== DEMO MODE ==========
// This dashboard uses sample data for demonstration purposes.
// In production, this connects to a Firebase backend.

// Load demo data from JSON file
async function loadData() {
  try {
    const response = await fetch('sample-data/demo-data.json?' + Date.now());
    if (!response.ok) throw new Error('Failed to load data');
    const data = await response.json();
    if (!data) throw new Error('No data');
    return data;
  } catch (error) {
    console.error('Error loading data:', error);
    return null;
  }
}

// Initialize dashboard
async function init() {
  const D = await loadData();
  
  if (!D) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').classList.add('show');
    document.querySelector('.error-message').textContent = 'Could not load demo data. Please ensure sample-data/demo-data.json exists.';
    return;
  }
  
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('dashboard').classList.add('show');
  
  renderDashboard(D);
}

function renderDashboard(D) {
  const fmt = v => '$' + Math.round(v).toLocaleString();
  const pct = (v, s = true) => (s && v > 0 ? '+' : '') + v.toFixed(1) + '%';

  Chart.defaults.color = 'rgb(156 163 175)';
  Chart.defaults.borderColor = 'rgba(59, 130, 246, 0.15)';
  Chart.defaults.font.family = "'Inter', sans-serif";
  const colors = {blue:'#3B82F6',green:'#10B981',purple:'#8B5CF6',orange:'#F97316',red:'#EF4444',yellow:'#F59E0B'};

  // Set data period
  document.getElementById('dataPeriod').textContent = D.metadata?.period || 'November 2025';

  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  }));

  const kpiIcons = [
    '<path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
    '<path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
    '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
    '<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>',
    '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>'
  ];
  const k = D.kpi_cards;
  document.getElementById('kpis').innerHTML = [
    ['Revenue', k.revenue.value, true, k.revenue.mom_pct, k.revenue.yoy_pct],
    ['Profit', k.profit.value, true, k.profit.mom_pct, k.profit.yoy_pct],
    ['Transactions', k.transactions.value, false, k.transactions.mom_pct, k.transactions.yoy_pct],
    ['Avg Ticket', k.avg_ticket.value, true, k.avg_ticket.mom_pct, k.avg_ticket.yoy_pct],
    ['Margin', k.margin.value, false, k.margin.mom_delta, k.margin.yoy_delta]
  ].map(([lbl, val, cur, mom, yoy], i) => `<div class="kpi-card" style="animation-delay:${i*80}ms"><div class="kpi-header"><div class="kpi-label">${lbl}</div><div class="kpi-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${kpiIcons[i]}</svg></div></div><div class="kpi-value">${cur ? fmt(val) : (val < 100 ? val.toFixed(1) + '%' : val.toLocaleString())}</div><div class="kpi-compare"><span><span class="label">MoM</span><span class="${mom >= 0 ? 'up' : 'down'}">${pct(mom)}</span></span><span><span class="label">YoY</span><span class="${yoy >= 0 ? 'up' : 'down'}">${pct(yoy)}</span></span></div></div>`).join('');

  document.getElementById('actionItems').innerHTML = D.action_items.length > 0 ? D.action_items.map((a, i) => `<div class="action ${a.type}"><div class="action-icon">${i + 1}</div><div><div class="action-title">${a.title}</div><div class="action-text">${a.text}</div><div class="action-cta">‚Üí ${a.action}</div></div></div>`).join('') : '<div style="color:var(--text-muted);font-size:13px;padding:8px">No urgent actions this month ‚úì</div>';

  document.getElementById('storeCards').innerHTML = D.store_comparison.map(s => `
  <div class="store-card">
  <div class="store-header"><span class="store-name">${s.short_name}</span><span class="store-txns">${s.transactions.toLocaleString()} transactions</span></div>
  <div class="store-metrics">
  <div class="store-metric"><div class="store-metric-label">Avg Transaction</div><div class="store-metric-value">${fmt(s.avg_ticket)}</div><div class="store-cmp"><div class="store-cmp-item"><span class="store-cmp-lbl">MoM</span><span class="store-cmp-val ${s.avg_ticket_mom_pct >= 0 ? 'green' : 'red'}">${pct(s.avg_ticket_mom_pct)}</span></div><div class="store-cmp-item"><span class="store-cmp-lbl">YoY</span><span class="store-cmp-val ${s.avg_ticket_yoy_pct >= 0 ? 'green' : 'red'}">${pct(s.avg_ticket_yoy_pct)}</span></div></div></div>
  <div class="store-metric"><div class="store-metric-label">Txns / Day</div><div class="store-metric-value">${s.txns_per_day}</div><div class="store-cmp"><div class="store-cmp-item"><span class="store-cmp-lbl">MoM</span><span class="store-cmp-val ${s.txns_per_day_mom_pct >= 0 ? 'green' : 'red'}">${pct(s.txns_per_day_mom_pct)}</span></div><div class="store-cmp-item"><span class="store-cmp-lbl">YoY</span><span class="store-cmp-val ${s.txns_per_day_yoy_pct >= 0 ? 'green' : 'red'}">${pct(s.txns_per_day_yoy_pct)}</span></div></div></div>
  </div>
  </div>`).join('');

  new Chart(document.getElementById('revenueChart'), {type:'line',data:{labels:D.daily_revenue.map(d=>new Date(d.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})),datasets:[{data:D.daily_revenue.map(d=>d.revenue),borderColor:colors.blue,backgroundColor:'rgba(59,130,246,0.15)',fill:true,tension:.4,pointRadius:0,pointHoverRadius:8,pointHoverBackgroundColor:colors.blue,pointHoverBorderColor:'white',pointHoverBorderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{color:'rgba(59,130,246,0.1)'},ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}}},interaction:{intersect:false,mode:'index'}}});

  document.getElementById('marginAlerts').innerHTML = D.margin_alerts.map(m => `<tr><td>${(m.name||'').substring(0,28)}</td><td>${m.store.includes('Lewiston')?'Lewiston':'Greene'}</td><td class="right">${fmt(m.revenue)}</td><td class="right ${m.margin_pct < 35 ? 'red' : 'yellow'}">${m.margin_pct}%</td><td class="right purple">+${m.price_increase_pct}%</td><td><span class="badge badge-${m.status}">${m.status}</span></td></tr>`).join('');

  document.getElementById('reorderRecs').innerHTML = D.reorder_recs.map(r => `<tr><td>${r.product}</td><td>${r.category}</td><td class="right">${r.daily_velocity}/day</td><td class="right blue">${r.reorder_qty} units</td><td><span class="badge badge-${r.urgency === 'high' ? 'high' : 'medium'}">${r.urgency}</span></td></tr>`).join('');

  document.getElementById('topPerformers').innerHTML = D.top_performers.map(p => `<tr><td>${(p.name||'').substring(0,32)}</td><td>${p.category}</td><td class="right">${p.units_sold}</td><td class="right green">${fmt(p.revenue)}</td><td class="right blue">${fmt(p.profit)}</td><td class="right">${p.margin_pct}%</td></tr>`).join('');

  new Chart(document.getElementById('categoryChart'), {type:'doughnut',data:{labels:D.category_mix.map(c=>c.category),datasets:[{data:D.category_mix.map(c=>c.revenue),backgroundColor:[colors.blue,colors.purple,colors.green,colors.orange,colors.yellow,'#64748b'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:14,padding:16,font:{size:12}}}}}});

  document.getElementById('staffingRecs').innerHTML = D.staffing_recs.map(s => `<div class="staff-card ${s.type}"><div class="staff-day">${s.day}</div><div class="staff-type">${s.type === 'peak' ? 'üìà Peak Day' : 'üìâ Slow Day'}</div><div class="staff-rec">${s.recommendation}</div></div>`).join('');

  document.getElementById('budtenderTable').innerHTML = D.budtender_scorecard.map(b => `<tr><td>${b.name}</td><td>${b.short_store}</td><td class="right green">${fmt(b.revenue)}</td><td class="right">${b.transactions}</td><td class="right">${fmt(b.avg_ticket)}</td><td class="right ${b.vs_avg_ticket >= 0 ? 'green' : 'red'}">${pct(b.vs_avg_ticket)}</td><td class="right">${b.items_per_txn}</td><td>${b.context_flags && b.context_flags.length > 0 ? `<div class="ctx-flags">${b.context_flags.map(f => `<span class="ctx-flag">${f}</span>`).join('')}</div>` : '‚Äî'}</td></tr>`).join('');

  const r = D.retention_summary;
  document.getElementById('retentionCards').innerHTML = `
  <div class="ret-card"><div class="ret-val">${r.total_customers.toLocaleString()}</div><div class="ret-lbl">Total Customers</div></div>
  <div class="ret-card"><div class="ret-val">${r.returning_customers.toLocaleString()}</div><div class="ret-lbl">Returning</div></div>
  <div class="ret-card"><div class="ret-val" style="color:${r.retention_rate > 30 ? 'var(--green-500)' : 'var(--red-500)'}; text-shadow: 0 0 20px ${r.retention_rate > 30 ? 'var(--green-glow)' : 'rgba(239,68,68,0.5)'}">${r.retention_rate}%</div><div class="ret-lbl">Retention Rate</div></div>
  <div class="ret-card"><div class="ret-val">${r.avg_days_since_visit}</div><div class="ret-lbl">Avg Days Since Visit</div></div>`;

  const segColors = {VIP:'purple',Regular:'blue',Occasional:'yellow','One-time':''};
  document.getElementById('segments').innerHTML = D.segment_health.map(s => `<div class="seg-card"><div class="seg-name">${s.segment}</div><div class="seg-count ${segColors[s.segment]||''}">${s.count.toLocaleString()}</div><div class="seg-rev">${fmt(s.total_revenue)}</div></div>`).join('');

  const cs = D.churn_summary;
  document.getElementById('churnStats').innerHTML = `<div class="churn-stat"><div class="churn-val red">${cs.high}</div><div class="churn-lbl">High Risk</div></div><div class="churn-stat"><div class="churn-val yellow">${cs.medium}</div><div class="churn-lbl">Medium Risk</div></div><div class="churn-stat"><div class="churn-val green">${cs.low}</div><div class="churn-lbl">Low Risk</div></div><div class="churn-stat"><div class="churn-val purple">${fmt(cs.total_at_risk)}</div><div class="churn-lbl">$ at Risk</div></div>`;

  document.getElementById('churnTable').innerHTML = D.churn_predictions.slice(0, 50).map(c => `<tr><td><span class="badge badge-${c.risk_level.toLowerCase()}">${c.risk_level}</span></td><td>${c.customer}</td><td><span class="badge badge-${(c.segment||'').toLowerCase()}">${c.segment}</span></td><td class="right ${c.churn_probability >= 60 ? 'red' : 'yellow'}">${c.churn_probability}%</td><td class="right purple">${fmt(c.revenue_at_risk)}</td><td class="right green">${fmt(c.total_spend)}</td><td>${c.last_visit}</td></tr>`).join('');

  document.getElementById('pairsTable').innerHTML = D.cross_category_pairs.map(p => `<tr><td>${p.product_a}</td><td>${p.category_a}</td><td>${p.product_b}</td><td>${p.category_b}</td><td class="right purple">${p.times_together}</td><td class="right green">${p.lift}x</td></tr>`).join('');

  const cohorts = D.cohorts;
  const cohortYears = Object.keys(cohorts).sort();
  const allYears = [2021, 2022, 2023, 2024, 2025];
  document.getElementById('cohortHead').innerHTML = `<tr><th>Cohort</th><th class="right">Size</th>${allYears.map(y=>`<th class="cohort-cell">${y}</th>`).join('')}</tr>`;
  document.getElementById('cohortTable').innerHTML = cohortYears.map(cy => { const c = cohorts[cy]; return `<tr><td><strong>${cy}</strong></td><td class="right">${c.cohort_size.toLocaleString()}</td>${allYears.map(y => { const d = c.yearly[y]; if (!d) return '<td class="cohort-cell">‚Äî</td>'; const ret = (d.customers / c.cohort_size * 100).toFixed(0); return `<td class="cohort-cell"><div class="cohort-val">$${d.avg_ltv.toFixed(0)}</div><div class="cohort-ret">${ret}% ret</div><div class="cohort-bar"><div class="cohort-fill" style="width:${Math.min(ret, 100)}%"></div></div></td>`; }).join('')}</tr>`; }).join('');

  document.getElementById('seasonalAlerts').innerHTML = D.seasonal_alerts.map(a => `<div class="s-alert ${a.type}"><div class="s-alert-icon">${a.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</div><div><h4>${a.title}</h4><p>${a.text}</p><div class="s-alert-action">‚Üí ${a.action}</div></div></div>`).join('');

  document.getElementById('weekForecast').innerHTML = `<div class="week-forecast">${D.next_4_weeks.map(w => `<div class="week-row"><div class="week-header"><span class="week-label">Week ${w.week}</span><span class="week-total">$${w.total.toLocaleString()}</span></div><div class="week-days">${w.days.map(d => `<div class="day-pill"><div class="day-name">${d.day_name}</div><div class="day-val">$${(d.forecast/1000).toFixed(1)}K</div></div>`).join('')}</div></div>`).join('')}</div>`;

  new Chart(document.getElementById('yoyChart'), {type:'bar',data:{labels:D.yoy_monthly.map(m=>m.month_name),datasets:[{label:'2024',data:D.yoy_monthly.map(m=>m.revenue_2024),backgroundColor:'rgba(107,114,128,0.5)',borderRadius:6},{label:'2025',data:D.yoy_monthly.map(m=>m.revenue_2025||0),backgroundColor:D.yoy_monthly.map(m=>!m.revenue_2025?'rgba(107,114,128,0.2)':m.yoy_pct>=0?'rgba(16,185,129,0.7)':'rgba(239,68,68,0.7)'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{boxWidth:14,padding:16}}},scales:{y:{grid:{color:'rgba(59,130,246,0.1)'},ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}},x:{grid:{display:false}}}}});

  const si = D.seasonal_indices;
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('monthsGrid').innerHTML = monthNames.map((name, i) => {
    const idx = si[String(i + 1)] || si[i + 1] || 1;
    const pctVal = ((idx - 1) * 100);
    const isPeak = idx >= 1.05;
    const isLow = idx <= 0.9;
    return `<div class="month-card ${isPeak ? 'peak' : isLow ? 'low' : ''}"><div class="month-name">${name}</div><div class="month-index">${idx.toFixed(2)}</div><div class="month-pct ${isPeak ? 'green' : isLow ? 'red' : ''}">${pctVal >= 0 ? '+' : ''}${pctVal.toFixed(0)}%</div></div>`;
  }).join('');
}

// Start the app
init();

// Table sorting functionality
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('sortable')) return;
  
  const th = e.target;
  const table = th.closest('table');
  const tbody = table.querySelector('tbody');
  const colIdx = parseInt(th.dataset.col);
  const isAsc = th.classList.contains('asc');
  
  // Remove sort classes from siblings
  th.parentElement.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
  th.classList.add(isAsc ? 'desc' : 'asc');
  
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.sort((a, b) => {
    let aVal = a.cells[colIdx]?.textContent.trim() || '';
    let bVal = b.cells[colIdx]?.textContent.trim() || '';
    
    // Extract numbers from strings like "$1,234" or "45.2%"
    const aNum = parseFloat(aVal.replace(/[$,%]/g, '').replace(/,/g, ''));
    const bNum = parseFloat(bVal.replace(/[$,%]/g, '').replace(/,/g, ''));
    
    if (!isNaN(aNum) && !isNaN(bNum)) {
      return isAsc ? bNum - aNum : aNum - bNum;
    }
    return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
  });
  
  rows.forEach(row => tbody.appendChild(row));
});

// ========== ADMIN PANEL ==========
const DISCOUNT_DAYS = {
  'Black Tie Cannabis Lewiston': {4: 'Friday: Flower 10% off', 6: 'Sunday: Edibles 20% off'},
  'Black Tie Cannabis': {4: 'Friday: Flower 10% off', 0: 'Monday: Edibles 20% off'}
};

let adminTxnData = [], adminUnitsData = [];
let clickCount = 0, clickTimer = null;

// Initialize admin panel after DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
  // Admin functionality disabled in demo mode
  // In production, triple-click logo opens admin panel for data updates
  console.log('Demo mode: Admin panel disabled. View sample data.');
});

// ========== CSV PROCESSING ==========
function processData(txnRaw, unitsRaw) {
  const txn = txnRaw.filter(r => r['Customer Name'] && !r['Customer Name'].toLowerCase().includes('transaction')).map(r => {
    const date = parseDate(r['Completed At']);
    if (!date) return null;
    return {
      ...r, date,
      year: date.getFullYear(),
      month: date.getMonth() + 1,
      dow: (date.getDay() + 6) % 7,
      total_revenue: parseMoney(r['Cannabis Revenue']) + parseMoney(r['Non-Cannabis Revenue']),
      profit: parseMoney(r['Net Profit']),
      store: r['Store'] || ''
    };
  }).filter(Boolean);

  const units = unitsRaw.map(r => ({
    ...r,
    date: parseDate(r['Completed At']),
    revenue: parseMoney(r['Total Collected (Post-Discount, Post-Tax, Post-Fees)']),
    profit: parseMoney(r['Net Profit']),
    cost: parseMoney(r['Cost']),
    qty: parseFloat(r['Quantity Sold']) || 0
  }));

  const currentYear = Math.max(...txn.map(r => r.year));
  const currentMonth = Math.max(...txn.filter(r => r.year === currentYear).map(r => r.month));
  const currentTxn = txn.filter(r => r.year === currentYear && r.month === currentMonth);
  const prevMonthTxn = txn.filter(r => r.year === currentYear && r.month === currentMonth - 1);
  const prevYearTxn = txn.filter(r => r.year === currentYear - 1 && r.month === currentMonth);
  const ytdTxn = txn.filter(r => r.year === currentYear);

  const totalRev = sum(currentTxn, 'total_revenue');
  const totalProfit = sum(currentTxn, 'profit');
  const totalTxns = currentTxn.length;
  const avgTicket = totalTxns > 0 ? totalRev / totalTxns : 0;
  const margin = totalRev > 0 ? (totalProfit / totalRev) * 100 : 0;

  const prevMRev = sum(prevMonthTxn, 'total_revenue');
  const prevMProfit = sum(prevMonthTxn, 'profit');
  const prevMTxns = prevMonthTxn.length;
  const prevMTicket = prevMTxns > 0 ? prevMRev / prevMTxns : 0;
  const prevMMargin = prevMRev > 0 ? (prevMProfit / prevMRev) * 100 : 0;

  const prevYRev = sum(prevYearTxn, 'total_revenue');
  const prevYProfit = sum(prevYearTxn, 'profit');
  const prevYTxns = prevYearTxn.length;
  const prevYTicket = prevYTxns > 0 ? prevYRev / prevYTxns : 0;
  const prevYMargin = prevYRev > 0 ? (prevYProfit / prevYRev) * 100 : 0;

  const kpi_cards = {
    revenue: { value: rd(totalRev), mom_pct: rd(pctChg(totalRev, prevMRev)), yoy_pct: rd(pctChg(totalRev, prevYRev)) },
    profit: { value: rd(totalProfit), mom_pct: rd(pctChg(totalProfit, prevMProfit)), yoy_pct: rd(pctChg(totalProfit, prevYProfit)) },
    transactions: { value: totalTxns, mom_pct: rd(pctChg(totalTxns, prevMTxns)), yoy_pct: rd(pctChg(totalTxns, prevYTxns)) },
    avg_ticket: { value: rd(avgTicket), mom_pct: rd(pctChg(avgTicket, prevMTicket)), yoy_pct: rd(pctChg(avgTicket, prevYTicket)) },
    margin: { value: rd(margin,1), mom_delta: rd(margin - prevMMargin,1), yoy_delta: rd(margin - prevYMargin,1) }
  };

  const action_items = [];
  if (kpi_cards.revenue.yoy_pct < -10) action_items.push({type:'urgent',title:'Revenue Down YoY',text:`Revenue is ${Math.abs(kpi_cards.revenue.yoy_pct).toFixed(1)}% below last year.`,action:'Review marketing'});

  const stores = [...new Set(currentTxn.map(r => r.store))].filter(Boolean);
  const store_comparison = stores.map(store => {
    const curr = currentTxn.filter(r => r.store === store);
    const prevM = prevMonthTxn.filter(r => r.store === store);
    const prevY = prevYearTxn.filter(r => r.store === store);
    const cRev = sum(curr,'total_revenue'), cTxns = curr.length, cAvg = cTxns?cRev/cTxns:0, cPd = cTxns/30;
    const pMRev = sum(prevM,'total_revenue'), pMTxns = prevM.length, pMAvg = pMTxns?pMRev/pMTxns:0, pMPd = pMTxns/30;
    const pYRev = sum(prevY,'total_revenue'), pYTxns = prevY.length, pYAvg = pYTxns?pYRev/pYTxns:0, pYPd = pYTxns/30;
    return {
      store, short_name: store.includes('Lewiston')?'Lewiston':'Greene',
      transactions: cTxns, revenue: rd(cRev), avg_ticket: rd(cAvg),
      avg_ticket_mom_pct: rd(pctChg(cAvg,pMAvg)), avg_ticket_yoy_pct: rd(pctChg(cAvg,pYAvg)),
      txns_per_day: rd(cPd,1), txns_per_day_mom_pct: rd(pctChg(cPd,pMPd)), txns_per_day_yoy_pct: rd(pctChg(cPd,pYPd))
    };
  });

  const dailyMap = {};
  currentTxn.forEach(r => { const k = r.date.toISOString().split('T')[0]; dailyMap[k] = (dailyMap[k]||0) + r.total_revenue; });
  const daily_revenue = Object.entries(dailyMap).sort().map(([date,revenue]) => ({date, revenue: rd(revenue)}));

  const prodMap = {};
  units.forEach(u => {
    const k = u['Product']; if (!k) return;
    if (!prodMap[k]) prodMap[k] = {name:k,category:u['Category'],brand:u['Brand'],store:u['Store'],revenue:0,profit:0,units:0,cost:0};
    prodMap[k].revenue += u.revenue; prodMap[k].profit += u.profit; prodMap[k].units += u.qty; prodMap[k].cost += u.cost;
  });
  const products = Object.values(prodMap).map(p => ({...p, margin_pct: p.revenue>0?(p.profit/p.revenue)*100:0, daily_velocity: p.units/30}));

  const top_performers = products.sort((a,b)=>b.profit-a.profit).slice(0,20).map(p => ({
    name:p.name, category:p.category, brand:p.brand, store:p.store,
    revenue:rd(p.revenue), profit:rd(p.profit), units_sold:Math.round(p.units), margin_pct:rd(p.margin_pct,1)
  }));

  const margin_alerts = products.filter(p=>p.margin_pct<40&&p.revenue>500).sort((a,b)=>a.margin_pct-b.margin_pct).slice(0,20).map(p => ({
    name:p.name, store:p.store, revenue:rd(p.revenue), margin_pct:rd(p.margin_pct,1),
    price_increase_pct: Math.round(((0.4-p.margin_pct/100)/0.6)*100),
    status: p.margin_pct<35?'critical':'review'
  }));

  if (margin_alerts.length > 5) action_items.push({type:'warning',title:`${margin_alerts.length} Products Below 40% Margin`,text:'Review pricing needed.',action:'Check Products tab'});

  const reorder_recs = products.filter(p=>p.daily_velocity>=1).sort((a,b)=>b.daily_velocity-a.daily_velocity).slice(0,15).map(p => ({
    product:p.name.substring(0,40), category:p.category, daily_velocity:rd(p.daily_velocity,2),
    reorder_qty:Math.round(p.daily_velocity*7*1.2), urgency:p.daily_velocity>3?'high':'medium'
  }));

  const catMap = {};
  units.forEach(u => { const c=u['Category']; if(!c)return; if(!catMap[c])catMap[c]={category:c,revenue:0,profit:0,units:0}; catMap[c].revenue+=u.revenue; catMap[c].profit+=u.profit; catMap[c].units+=u.qty; });
  const category_mix = Object.values(catMap).sort((a,b)=>b.revenue-a.revenue).map(c=>({...c, margin_pct:c.revenue>0?rd((c.profit/c.revenue)*100,1):0}));

  const teamMap = {};
  currentTxn.forEach(t => {
    const n=t['Sold By']; if(!n)return;
    if(!teamMap[n]) teamMap[n]={name:n,store:t.store,revenue:0,profit:0,txns:0,dows:{}};
    teamMap[n].revenue+=t.total_revenue; teamMap[n].profit+=t.profit; teamMap[n].txns++; teamMap[n].dows[t.dow]=(teamMap[n].dows[t.dow]||0)+1;
  });

  const teamItems = {};
  units.forEach(u => { const n=u['Sold By']; if(!n)return; if(!teamItems[n])teamItems[n]={items:0,receipts:new Set()}; teamItems[n].items+=u.qty; teamItems[n].receipts.add(u['Receipt ID']); });

  const tAvgTicket = Object.values(teamMap).reduce((s,t)=>s+(t.txns?t.revenue/t.txns:0),0)/Object.keys(teamMap).length || 1;

  const budtender_scorecard = Object.values(teamMap).sort((a,b)=>b.revenue-a.revenue).slice(0,15).map(t => {
    const avgT = t.txns?t.revenue/t.txns:0;
    const iData = teamItems[t.name]||{items:t.txns,receipts:{size:t.txns}};
    const iPT = iData.receipts.size>0?iData.items/iData.receipts.size:1;
    const flags = [];
    const total = Object.values(t.dows).reduce((a,b)=>a+b,0);
    const sd = DISCOUNT_DAYS[t.store]||{};
    for (const [dow,promo] of Object.entries(sd)) {
      const pct = ((t.dows[dow]||0)/total)*100;
      if (pct>=25) flags.push(`Works ${Math.round(pct)}% ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][dow]}s (${promo.split(': ')[1]})`);
    }
    return {
      name:t.name, store:t.store, short_store:t.store.includes('Lewiston')?'Lewiston':'Greene',
      revenue:rd(t.revenue), transactions:t.txns, avg_ticket:rd(avgT),
      vs_avg_ticket:rd(((avgT-tAvgTicket)/tAvgTicket)*100,1), items_per_txn:rd(iPT,2), context_flags:flags
    };
  });

  const dowRev = {};
  ytdTxn.forEach(t => { dowRev[t.dow]=(dowRev[t.dow]||0)+t.total_revenue; });
  const dowAvg = Object.values(dowRev).reduce((a,b)=>a+b,0)/7;
  const dowNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const staffing_recs = [];
  for (let i=0;i<7;i++) {
    const idx = (dowRev[i]||dowAvg)/dowAvg;
    if (idx>1.2) staffing_recs.push({day:dowNames[i],type:'peak',index:rd(idx,2),recommendation:`Peak day. ${Math.round((idx-1)*100)}% above avg.`});
    else if (idx<0.85) staffing_recs.push({day:dowNames[i],type:'slow',index:rd(idx,2),recommendation:`Slow day. ${Math.round((1-idx)*100)}% below avg.`});
  }

  const custMap = {};
  ytdTxn.forEach(t => {
    const n=t['Customer Name']; if(!n)return;
    if(!custMap[n]) custMap[n]={name:n,spend:0,visits:0,first:t.date,last:t.date};
    custMap[n].spend+=t.total_revenue; custMap[n].visits++;
    if(t.date<custMap[n].first)custMap[n].first=t.date;
    if(t.date>custMap[n].last)custMap[n].last=t.date;
  });

  const now = new Date();
  const customers = Object.values(custMap).map(c => {
    const days = Math.floor((now-c.last)/(1000*60*60*24));
    let seg = 'One-time';
    if (c.visits>=5||c.spend>=500) seg='VIP';
    else if (c.visits>=2) seg='Regular';
    else if (c.spend>=50) seg='Occasional';
    const churn = Math.min(95, (Math.min(days/180,1)*50) + Math.max(0,50-c.visits*5));
    return {...c, seg, days, churn, risk: churn>=60?'HIGH':churn>=35?'MEDIUM':'LOW', atRisk:c.spend*churn/100};
  });

  const retention_summary = {
    total_customers: customers.length,
    returning_customers: customers.filter(c=>c.visits>=2).length,
    retention_rate: rd((customers.filter(c=>c.visits>=2).length/customers.length)*100,1),
    avg_days_since_visit: Math.round(customers.reduce((s,c)=>s+c.days,0)/customers.length)
  };

  const segCounts = {};
  customers.forEach(c => { if(!segCounts[c.seg])segCounts[c.seg]={segment:c.seg,count:0,total_revenue:0}; segCounts[c.seg].count++; segCounts[c.seg].total_revenue+=c.spend; });
  const segment_health = Object.values(segCounts);

  const churn_summary = {
    high: customers.filter(c=>c.risk==='HIGH').length,
    medium: customers.filter(c=>c.risk==='MEDIUM').length,
    low: customers.filter(c=>c.risk==='LOW').length,
    total_at_risk: rd(customers.filter(c=>c.risk==='HIGH').reduce((s,c)=>s+c.atRisk,0))
  };

  if (churn_summary.high>400) action_items.push({type:'urgent',title:`${churn_summary.high} High-Risk Customers`,text:`$${Math.round(churn_summary.total_at_risk).toLocaleString()} at risk.`,action:'Win-back campaign'});

  const churn_predictions = customers.filter(c=>c.risk!=='LOW').sort((a,b)=>b.atRisk-a.atRisk).slice(0,100).map(c => ({
    customer:c.name.substring(0,30), risk_level:c.risk, churn_probability:Math.round(c.churn),
    total_spend:rd(c.spend), last_visit:c.last.toLocaleDateString(), segment:c.seg, revenue_at_risk:rd(c.atRisk), preferred_products:[]
  }));

  const rcpts = {};
  units.forEach(u => { const r=u['Receipt ID']; if(!r)return; if(!rcpts[r])rcpts[r]=[]; rcpts[r].push({p:u['Product'],c:u['Category']}); });
  const pairCnts = {}, prodCnts = {};
  Object.values(rcpts).filter(i=>i.length>=2).forEach(items => {
    const uniq = [...new Map(items.map(i=>[i.p,i])).values()];
    uniq.forEach(i => { prodCnts[i.p]=(prodCnts[i.p]||0)+1; });
    for (let i=0;i<uniq.length;i++) for (let j=i+1;j<uniq.length;j++) if (uniq[i].c!==uniq[j].c) {
      const k=[uniq[i].p,uniq[j].p].sort().join('|||'); pairCnts[k]=(pairCnts[k]||0)+1;
    }
  });
  const totRcpts = Object.keys(rcpts).length;
  const cross_category_pairs = Object.entries(pairCnts).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k,cnt]) => {
    const [p1,p2]=k.split('|||');
    const c1=units.find(u=>u['Product']===p1)?.Category||'';
    const c2=units.find(u=>u['Product']===p2)?.Category||'';
    const conf = Math.max((cnt/(prodCnts[p1]||1))*100,(cnt/(prodCnts[p2]||1))*100);
    const exp = ((prodCnts[p1]||1)/totRcpts)*((prodCnts[p2]||1)/totRcpts)*totRcpts;
    return {product_a:p1.substring(0,35),category_a:c1,product_b:p2.substring(0,35),category_b:c2,times_together:cnt,confidence_pct:rd(conf,1),lift:rd(cnt/exp,1)};
  });

  const firstP = {};
  txn.forEach(t => { const n=t['Customer Name']; if(!n)return; if(!firstP[n]||t.date<firstP[n])firstP[n]=t.date; });
  const cohortD = {};
  txn.forEach(t => {
    const n=t['Customer Name']; if(!n||!firstP[n])return;
    const cy = firstP[n].getFullYear(), y = t.year;
    if(!cohortD[cy]) cohortD[cy]={size:new Set(),yearly:{}};
    cohortD[cy].size.add(n);
    if(!cohortD[cy].yearly[y]) cohortD[cy].yearly[y]={custs:new Set(),spend:0};
    cohortD[cy].yearly[y].custs.add(n); cohortD[cy].yearly[y].spend+=t.total_revenue;
  });
  const cohorts = {};
  for (const [cy,d] of Object.entries(cohortD)) {
    cohorts[cy] = {cohort_size:d.size.size, yearly:Object.fromEntries(Object.entries(d.yearly).map(([y,v])=>[y,{customers:v.custs.size,total_spend:rd(v.spend),avg_ltv:rd(v.spend/v.custs.size)}]))};
  }

  const hist = txn.filter(t=>t.year<currentYear);
  const mRev = {};
  hist.forEach(t => { const k=`${t.year}-${t.month}`; mRev[k]=(mRev[k]||0)+t.total_revenue; });
  const yAvg = {};
  for (const [k,v] of Object.entries(mRev)) { const y=parseInt(k.split('-')[0]); if(!yAvg[y])yAvg[y]={t:0,c:0}; yAvg[y].t+=v; yAvg[y].c++; }
  for (const y in yAvg) yAvg[y]=yAvg[y].t/yAvg[y].c;
  const wts = {2021:1,2022:2,2023:3,2024:4};
  const seasonal_indices = {};
  for (let m=1;m<=12;m++) {
    let ws=0,wt=0;
    for (const [k,v] of Object.entries(mRev)) {
      const [y,mo]=k.split('-').map(Number);
      if (mo===m&&wts[y]) { ws+=(v/yAvg[y])*wts[y]; wt+=wts[y]; }
    }
    seasonal_indices[m]=wt>0?rd(ws/wt,3):1;
  }

  const seasonal_alerts = [];
  if (seasonal_indices[1]<0.9) seasonal_alerts.push({type:'warning',title:'January Slowdown',text:`${Math.round((1-seasonal_indices[1])*100)}% below avg.`,action:'Reduce inventory'});
  if (seasonal_indices[12]>1.05) seasonal_alerts.push({type:'positive',title:'December Peak',text:`${Math.round((seasonal_indices[12]-1)*100)}% above avg.`,action:'Stock up'});

  const dAvg = totalRev/30;
  const dowIdx = {}; for(let i=0;i<7;i++) dowIdx[i]=(dowRev[i]||dowAvg)/dowAvg;
  const nxtM = currentMonth<12?currentMonth+1:1;
  const nxtY = currentMonth<12?currentYear:currentYear+1;
  const start = new Date(nxtY,nxtM-1,1);
  const next_4_weeks = [];
  for (let w=0;w<4;w++) {
    const wd = {week:w+1,days:[],total:0};
    for (let d=0;d<7;d++) {
      const dt = new Date(start.getTime()+(w*7+d)*86400000);
      const dow = (dt.getDay()+6)%7;
      const seas = (seasonal_indices[nxtM]||1)/(seasonal_indices[currentMonth]||1);
      const fc = dAvg*(dowIdx[dow]||1)*seas;
      wd.days.push({date:`${dt.getMonth()+1}/${dt.getDate()}`,day_name:dowNames[dow].substring(0,3),forecast:Math.round(fc)});
      wd.total+=fc;
    }
    wd.total=Math.round(wd.total);
    next_4_weeks.push(wd);
  }

  const yoy_monthly = [];
  for (let m=1;m<=12;m++) {
    const prev = txn.filter(t=>t.year===currentYear-1&&t.month===m).reduce((s,t)=>s+t.total_revenue,0);
    const curr = txn.filter(t=>t.year===currentYear&&t.month===m).reduce((s,t)=>s+t.total_revenue,0);
    yoy_monthly.push({month:m,month_name:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1],revenue_2024:Math.round(prev),revenue_2025:curr?Math.round(curr):null,yoy_pct:prev&&curr?rd(pctChg(curr,prev),1):null});
  }

  const mNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  return {
    metadata: {period:`${mNames[currentMonth-1]} ${currentYear}`,generated_at:new Date().toISOString(),total_transactions:totalTxns,stores:stores},
    kpi_cards, action_items, store_comparison, daily_revenue,
    top_performers, margin_alerts, reorder_recs, category_mix, underperformers:[],
    budtender_scorecard, staffing_recs, team_avg_ticket:rd(tAvgTicket), team_avg_items:1,
    retention_summary, segment_health, churn_summary, churn_predictions, cohorts, cross_category_pairs,
    seasonal_indices, seasonal_alerts, next_4_weeks, yoy_monthly, dow_patterns:{},
    discount_days:{Lewiston:['Friday: Flower 10% off','Sunday: Edibles 20% off'],Greene:['Friday: Flower 10% off','Monday: Edibles 20% off']}
  };
}

function parseDate(str) {
  if (!str) return null;
  const m = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)?/i);
  if (m) {
    let [,mo,d,y,h,min,s,ap]=m; h=parseInt(h);
    if(ap?.toUpperCase()==='PM'&&h!==12)h+=12;
    if(ap?.toUpperCase()==='AM'&&h===12)h=0;
    return new Date(y,mo-1,d,h,min,s);
  }
  return new Date(str);
}
function parseMoney(s) { return s?parseFloat(String(s).replace(/[$,]/g,''))||0:0; }
function sum(arr,k) { return arr.reduce((s,r)=>s+(r[k]||0),0); }
function pctChg(c,p) { return p===0?0:((c-p)/p)*100; }
function rd(v,d=2) { return Math.round(v*Math.pow(10,d))/Math.pow(10,d); }
</script>
</body>
</html>
